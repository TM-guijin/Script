-- Mobile UI Library - 手机端优化版
local MobileUI = {}
MobileUI.__index = MobileUI

-- 服务引用
local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")

-- 工具函数
local function CreateInstance(className, props)
    local obj = Instance.new(className)
    for prop, value in pairs(props) do
        if pcall(function() return obj[prop] end) then
            obj[prop] = value
        end
    end
    return obj
end

local function Tween(object, properties, duration)
    local info = TweenInfo.new(duration or 0.25, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
    local tween = TweenService:Create(object, info, properties)
    tween:Play()
    return tween
end

-- 创建窗口
function MobileUI:CreateWindow(config)
    config = config or {}
    local window = setmetatable({}, MobileUI)
    
    -- 创建GUI容器
    window.Gui = CreateInstance("ScreenGui", {
        Name = "MobileUI_" .. math.random(1000, 9999),
        ResetOnSpawn = false,
        ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    })
    
    -- 自适应屏幕尺寸
    local screenSize = workspace.CurrentCamera.ViewportSize
    local width = math.min(screenSize.X * 0.9, 400)
    local height = math.min(screenSize.Y * 0.8, 600)
    
    -- 主窗口框架
    window.MainFrame = CreateInstance("Frame", {
        Size = UDim2.new(0, width, 0, height),
        Position = UDim2.new(0.5, 0, 0.5, 0),
        AnchorPoint = Vector2.new(0.5, 0.5),
        BackgroundColor3 = Color3.fromHex("#1a1a1a"),
        BackgroundTransparency = 0.1,
        Parent = window.Gui
    })
    
    -- 样式装饰
    CreateInstance("UICorner", {CornerRadius = UDim.new(0.04, 0), Parent = window.MainFrame})
    CreateInstance("UIStroke", {Color = Color3.fromHex("#00ff40"), Thickness = 2, Parent = window.MainFrame})
    
    -- 标题栏
    window.TitleBar = CreateInstance("Frame", {
        Size = UDim2.new(1, 0, 0, 50),
        BackgroundColor3 = Color3.fromHex("#2d2d2d"),
        Parent = window.MainFrame
    })
    
    window.Title = CreateInstance("TextLabel", {
        Text = config.Title or "Mobile UI",
        Size = UDim2.new(0.7, 0, 1, 0),
        Position = UDim2.new(0.15, 0, 0, 0),
        BackgroundTransparency = 1,
        TextColor3 = Color3.fromHex("#00ff40"),
        Font = Enum.Font.GothamBold,
        TextSize = 18,
        TextXAlignment = Enum.TextXAlignment.Left,
        Parent = window.TitleBar
    })
    
    -- 关闭按钮
    window.CloseButton = CreateInstance("TextButton", {
        Text = "×",
        Size = UDim2.new(0, 40, 0, 40),
        Position = UDim2.new(1, -45, 0.5, -20),
        AnchorPoint = Vector2.new(0, 0.5),
        BackgroundTransparency = 1,
        TextColor3 = Color3.fromHex("#ff4444"),
        Font = Enum.Font.GothamBold,
        TextSize = 24,
        AutoButtonColor = false,
        Parent = window.TitleBar
    })
    
    -- 标签按钮区域
    window.TabButtons = CreateInstance("ScrollingFrame", {
        Size = UDim2.new(1, 0, 0, 60),
        Position = UDim2.new(0, 0, 0, 50),
        BackgroundTransparency = 1,
        ScrollBarThickness = 0,
        CanvasSize = UDim2.new(2, 0, 0, 0),
        Parent = window.MainFrame
    })
    
    CreateInstance("UIListLayout", {
        FillDirection = Enum.FillDirection.Horizontal,
        SortOrder = Enum.SortOrder.LayoutOrder,
        Padding = UDim.new(0, 5),
        Parent = window.TabButtons
    })
    
    -- 内容区域
    window.ContentFrame = CreateInstance("ScrollingFrame", {
        Size = UDim2.new(1, -20, 1, -120),
        Position = UDim2.new(0, 10, 0, 120),
        BackgroundTransparency = 1,
        ScrollBarThickness = 4,
        CanvasSize = UDim2.new(0, 0, 2, 0),
        Parent = window.MainFrame
    })
    
    CreateInstance("UIListLayout", {
        SortOrder = Enum.SortOrder.LayoutOrder,
        Padding = UDim.new(0, 10),
        Parent = window.ContentFrame
    })
    
    window.Tabs = {}
    window.CurrentTab = nil
    
    -- 关闭按钮事件
    window.CloseButton.MouseButton1Click:Connect(function()
        window:Destroy()
    end)
    
    -- 添加标签页方法
    function window:AddTab(name)
        local tab = {Name = name, Elements = {}}
        
        local tabButton = CreateInstance("TextButton", {
            Text = name,
            Size = UDim2.new(0, 120, 0, 50),
            BackgroundColor3 = Color3.fromHex("#2d2d2d"),
            BackgroundTransparency = 0.3,
            TextColor3 = Color3.fromHex("#cccccc"),
            Font = Enum.Font.Gotham,
            TextSize = 14,
            AutoButtonColor = false,
            Parent = self.TabButtons
        })
        
        CreateInstance("UICorner", {CornerRadius = UDim.new(0.02, 0), Parent = tabButton})
        
        local tabContent = CreateInstance("Frame", {
            Size = UDim2.new(1, 0, 0, 0),
            BackgroundTransparency = 1,
            Visible = false,
            Parent = self.ContentFrame
        })
        
        -- 标签切换逻辑
        tabButton.MouseButton1Click:Connect(function()
            for _, existingTab in pairs(self.Tabs) do
                existingTab.Content.Visible = false
                Tween(existingTab.Button, {BackgroundColor3 = Color3.fromHex("#2d2d2d")})
            end
            tabContent.Visible = true
            Tween(tabButton, {BackgroundColor3 = Color3.fromHex("#00ff40")})
            self.CurrentTab = tab
        end)
        
        tab.Button = tabButton
        tab.Content = tabContent
        table.insert(self.Tabs, tab)
        
        -- 默认选中第一个标签
        if #self.Tabs == 1 then
            tabButton:MouseButton1Click()
        end
        
        -- 添加按钮方法
        function tab:AddButton(text, callback)
            local button = CreateInstance("TextButton", {
                Text = text,
                Size = UDim2.new(1, -20, 0, 50),
                BackgroundColor3 = Color3.fromHex("#2d2d2d"),
                BackgroundTransparency = 0.3,
                TextColor3 = Color3.fromHex("#ffffff"),
                Font = Enum.Font.Gotham,
                TextSize = 16,
                AutoButtonColor = false,
                Parent = self.Content
            })
            
            CreateInstance("UICorner", {CornerRadius = UDim.new(0.03, 0), Parent = button})
            CreateInstance("UIStroke", {Color = Color3.fromHex("#00ff40"), Thickness = 1, Parent = button})
            
            button.MouseButton1Click:Connect(function()
                if callback then pcall(callback) end
            end)
            
            return button
        end
        
        -- 添加开关方法
        function tab:AddToggle(text, defaultValue, callback)
            local toggleFrame = CreateInstance("Frame", {
                Size = UDim2.new(1, -20, 0, 50),
                BackgroundTransparency = 1,
                Parent = self.Content
            })
            
            local label = CreateInstance("TextLabel", {
                Text = text,
                Size = UDim2.new(0.7, 0, 1, 0),
                BackgroundTransparency = 1,
                TextColor3 = Color3.fromHex("#ffffff"),
                Font = Enum.Font.Gotham,
                TextSize = 16,
                TextXAlignment = Enum.TextXAlignment.Left,
                Parent = toggleFrame
            })
            
            local state = defaultValue or false
            local toggleBg = CreateInstance("Frame", {
                Size = UDim2.new(0, 60, 0, 30),
                Position = UDim2.new(1, -70, 0.5, -15),
                AnchorPoint = Vector2.new(0, 0.5),
                BackgroundColor3 = state and Color3.fromHex("#00ff40") or Color3.fromHex("#666666"),
                Parent = toggleFrame
            })
            
            CreateInstance("UICorner", {CornerRadius = UDim.new(0.5, 0), Parent = toggleBg})
            
            local toggleSlider = CreateInstance("Frame", {
                Size = UDim2.new(0, 26, 0, 26),
                AnchorPoint = Vector2.new(0.5, 0.5),
                Position = state and UDim2.new(0.75, 0, 0.5, 0) or UDim2.new(0.25, 0, 0.5, 0),
                BackgroundColor3 = Color3.new(1, 1, 1),
                Parent = toggleBg
            })
            
            CreateInstance("UICorner", {CornerRadius = UDim.new(0.5, 0), Parent = toggleSlider})
            
            local hitbox = CreateInstance("TextButton", {
                Size = UDim2.new(0, 60, 0, 30),
                Position = UDim2.new(1, -70, 0.5, -15),
                AnchorPoint = Vector2.new(0, 0.5),
                BackgroundTransparency = 1,
                Text = "",
                Parent = toggleFrame
            })
            
            hitbox.MouseButton1Click:Connect(function()
                state = not state
                Tween(toggleBg, {BackgroundColor3 = state and Color3.fromHex("#00ff40") or Color3.fromHex("#666666")})
                Tween(toggleSlider, {Position = state and UDim2.new(0.75, 0, 0.5, 0) or UDim2.new(0.25, 0, 0.5, 0)})
                if callback then pcall(callback, state) end
            end)
            
            return {SetState = function(value) state = value end}
        end
        
        -- 添加滑块方法
        function tab:AddSlider(text, min, max, defaultValue, callback)
            local sliderFrame = CreateInstance("Frame", {
                Size = UDim2.new(1, -20, 0, 80),
                BackgroundTransparency = 1,
                Parent = self.Content
            })
            
            local label = CreateInstance("TextLabel", {
                Text = text,
                Size = UDim2.new(1, 0, 0, 30),
                BackgroundTransparency = 1,
                TextColor3 = Color3.fromHex("#ffffff"),
                Font = Enum.Font.Gotham,
                TextSize = 16,
                TextXAlignment = Enum.TextXAlignment.Left,
                Parent = sliderFrame
            })
            
            local valueLabel = CreateInstance("TextLabel", {
                Text = tostring(defaultValue or min),
                Size = UDim2.new(0.3, 0, 0, 30),
                Position = UDim2.new(0.7, 0, 0, 0),
                BackgroundTransparency = 1,
                TextColor3 = Color3.fromHex("#00ff40"),
                Font = Enum.Font.Gotham,
                TextSize = 16,
                TextXAlignment = Enum.TextXAlignment.Right,
                Parent = sliderFrame
            })
            
            local sliderBg = CreateInstance("Frame", {
                Size = UDim2.new(1, 0, 0, 6),
                Position = UDim2.new(0, 0, 0, 40),
                BackgroundColor3 = Color3.fromHex("#444444"),
                Parent = sliderFrame
            })
            
            CreateInstance("UICorner", {CornerRadius = UDim.new(0.5, 0), Parent = sliderBg})
            
            local sliderFill = CreateInstance("Frame", {
                Size = UDim2.new((defaultValue - min) / (max - min), 0, 1, 0),
                BackgroundColor3 = Color3.fromHex("#00ff40"),
                Parent = sliderBg
            })
            
            CreateInstance("UICorner", {CornerRadius = UDim.new(0.5, 0), Parent = sliderFill})
            
            local sliderHandle = CreateInstance("Frame", {
                Size = UDim2.new(0, 20, 0, 20),
                AnchorPoint = Vector2.new(0.5, 0.5),
                BackgroundColor3 = Color3.new(1, 1, 1),
                Position = UDim2.new((defaultValue - min) / (max - min), 0, 0.5, 0),
                Parent = sliderBg
            })
            
            CreateInstance("UICorner", {CornerRadius = UDim.new(0.5, 0), Parent = sliderHandle})
            CreateInstance("UIStroke", {Color = Color3.fromHex("#00ff40"), Thickness = 2, Parent = sliderHandle})
            
            local currentValue = defaultValue or min
            local dragging = false
            
            local function updateSlider(value)
                currentValue = math.clamp(value, min, max)
                local percent = (currentValue - min) / (max - min)
                sliderFill.Size = UDim2.new(percent, 0, 1, 0)
                sliderHandle.Position = UDim2.new(percent, 0, 0.5, 0)
                valueLabel.Text = tostring(math.floor(currentValue))
                if callback then pcall(callback, currentValue) end
            end
            
            sliderBg.InputBegan:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.Touch then
                    dragging = true
                    local percent = (input.Position.X - sliderBg.AbsolutePosition.X) / sliderBg.AbsoluteSize.X
                    updateSlider(min + percent * (max - min))
                end
            end)
            
            UserInputService.InputChanged:Connect(function(input)
                if dragging and input.UserInputType == Enum.UserInputType.Touch then
                    local percent = (input.Position.X - sliderBg.AbsolutePosition.X) / sliderBg.AbsoluteSize.X
                    updateSlider(min + percent * (max - min))
                end
            end)
            
            UserInputService.InputEnded:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.Touch then
                    dragging = false
                end
            end)
            
            return {SetValue = updateSlider}
        end
        
        return tab
    end
    
    -- 窗口显示方法
    function window:Show()
        self.Gui.Parent = Players.LocalPlayer:WaitForChild("PlayerGui")
        self.MainFrame.Size = UDim2.new(0, 0, 0, 0)
        Tween(self.MainFrame, {Size = UDim2.new(0, width, 0, height)}, 0.3)
    end
    
    -- 窗口隐藏方法
    function window:Hide()
        Tween(self.MainFrame, {Size = UDim2.new(0, 0, 0, 0)}, 0.3)
        task.wait(0.3)
        self.Gui.Enabled = false
    end
    
    -- 窗口销毁方法
    function window:Destroy()
        self:Hide()
        task.wait(0.3)
        if self.Gui then
            self.Gui:Destroy()
        end
    end
    
    -- 自动显示窗口
    window:Show()
    return window
end

return MobileUI